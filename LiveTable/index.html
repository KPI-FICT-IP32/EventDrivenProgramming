<!DOCTYPE html>
<html>
<body>
<h1>Live table</h1>
<table id="table"></table>
<style>
input { border: 1px solid green; width: 30px; }
</style>
<script src="/reactivity.js" type="text/javascript"></script>
<script src="/formula.js" type="text/javascript"></script>
<script>
  'use strict';
  const socket = new WebSocket('ws://127.0.0.1:8042/');
  const eventBus = new reactivity.WSObservable(socket);
  var inputMode = false;
  const table = document.getElementById('table');
  const letters = ['A', 'B', 'C', 'D', 'E', 'F'];

  // TODO: find a way to replace this with something more beautiful
  let tr;
  tr = document.createElement('tr');
  tr.innerHTML = `<td></td>${letters.map((col) => `<td> ${col} </td>`).join('')}`;
  table.appendChild(tr);

  for (let i = 1; i <= 5; i++) {
    tr = document.createElement('tr');
    tr.innerHTML = '<td>' + i + '</td>' + letters.map((col) => {
      return `<td><input id="${col}${i}" type="text"></td>`;
    }).join('');
    table.appendChild(tr);
    letters.forEach((col) => {
      let cell = col + i;
      let input = document.getElementById(cell);
      
      // cell._referenced_by shows which cells should be recalculated when current cell changes
      input._referenced_by = [];
      
      const listener = (
          eventBus
          .filter((data) => data.cell === cell )
          .subscribe(({value, source}) => {
            //FIXME: not elegant way to not apply changes if current client is a source of change
            if(!inputMode) {
              var _cells = {};
              
              input._formula = new formula.Formula(value);
              
              input._formula.cell_names.forEach((d) => {
                let cell = document.getElementById(d);
                
                _cells[d] = cell.value;

                // FIXME: remove reference to the certain cell when current cell is no longer referenced by the certain cell
                // TODO: Change to something more elegant
                if(cell._referenced_by.indexOf(input.id) == -1)
                  cell._referenced_by.push(input.id);

                input._referenced_by.forEach(d => {
                  let cell = document.getElementById(d);
                  // send message to cells which refers to the current cell 
                  eventBus.emit({
                    cell: cell.id,
                    value: cell._formula._str
                  });
                });

              });
              
              input.value = input._formula.evaluate(_cells);

            }
          })
      );
      // when focusing in the input, shows actual formula's raw string
      input.addEventListener('focus', focusin);
      // when focus out - shows calculated formula
      input.addEventListener('blur', focusout);
    });
  }


  function focusin({target}) {
    // force focusout event for previously focused element

    inputMode = true;
    target.value = target._formula ? target._formula._str : ''; 
  }

  function focusout({target}) {
    let _cells = {}
    
    target._formula = new formula.Formula(target.value.trim());

    target._formula.cell_names.forEach((d) => {
      let value = document.getElementById(d).value
      _cells[d] = value;
    });

    
    eventBus.emit({
      cell: target.id,
      value: target._formula._str,
    });

    target._referenced_by.forEach((d) => {
      let cell = document.getElementById(d);

      // send refresh event to the cells which depends on current cell
      eventBus.emit({
        cell: cell.id,
        value: cell._formula._str
      })
    })

    inputMode = false;

    target.value = target._formula.evaluate(_cells); 

  }
</script>
</body>
</html>


<!-- vim: set ts=2 sw=2 tw=0 et :-->
