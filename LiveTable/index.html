<!DOCTYPE html>
<html>
<body>
<h1>Live table</h1>
<table id="table"></table>
<style>
input { border: 1px solid green; width: 30px; }
</style>
<script src="/reactivity.js" type="text/javascript"></script>
<script>

  const eventBus = new reactivity.Observable();

  const table = document.getElementById('table');
  const letters = ['A', 'B', 'C', 'D', 'E', 'F'];

  let tr;
  tr = document.createElement('tr');
  tr.innerHTML = `<td></td>${letters.map((col) => `<td> ${col} </td>`).join('')}`;
  table.appendChild(tr);

  for (let i = 1; i <= 5; i++) {
    tr = document.createElement('tr');
    tr.innerHTML = '<td>' + i + '</td>' + letters.map((col) => {
      return `<td><input id="${col}${i}" type="text"></td>`;
    }).join('');
    table.appendChild(tr);
    letters.forEach((col) => {
      let cell = col + i;
      let input = document.getElementById(cell);
      const listener = (
          eventBus
          .filter(({data, _source}) => data.cell === cell && _source === 'remote')
          .subscribe(({data}) => {input.value = data.value;})
      );
      input.addEventListener('keyup', keyup);
    });
  }

  function keyup({target}) {
    eventBus.emit({
      _source: 'local',
      data: {
        cell: target.id,
        value: target.value,
      },
    });
  }

  const socket = new WebSocket('ws://127.0.0.1:8042/');
  // TODO: write a websocket Observable wrapper 
  // FIXME: get rid of manually managing _source (do that in wrapper)
  const wslistener = (
      eventBus
      .filter(({_source}) => _source === 'local')
      .subscribe(({data}) => { socket.send(JSON.stringify(data)); })
  );

  socket.onmessage = function(event) {
    let change = JSON.parse(event.data);
    eventBus.emit({_source: 'remote', data: change});
  };

</script>
</body>
</html>


<!-- vim: set ts=2 sw=2 tw=0 et :-->
